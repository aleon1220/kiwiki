# Security and chryptography

- [Security and chryptography](#security-and-chryptography)
  - [Security and Chryptography](#security-and-chryptography-1)
      - [Generate security encryption keys to sign packages](#generate-security-encryption-keys-to-sign-packages)
      - [2048 bits initial encryption. Upgraded to 4096 bits](#2048-bits-initial-encryption-upgraded-to-4096-bits)
- [Encryption Concepts](#encryption-concepts)
  - [Certificate filename extensions](#certificate-filename-extensions)
    - [X.509 Certificate](#x509-certificate)
  - [In cryptography, X.509 is a standard defining the format of public key certificates.](#in-cryptography-x509-is-a-standard-defining-the-format-of-public-key-certificates)
    - [Analyze and Check artifacts generated by `OpenSSL`](#analyze-and-check-artifacts-generated-by-openssl)
      - [Check RSA Key](#check-rsa-key)
      - [Check X509 certificate](#check-x509-certificate)
      - [read metadata of certificate and key](#read-metadata-of-certificate-and-key)
      - [Convert private key to PKCS#5 v2.0 format using triple DES](#convert-private-key-to-pkcs5-v20-format-using-triple-des)
      - [Convert a private key to PKCS#8 using a PKCS#5 1.5 compatible algorithm (DES)](#convert-a-private-key-to-pkcs8-using-a-pkcs5-15-compatible-algorithm-des)
      - [Convert a private key to PKCS#8 using a PKCS#12 compatible algorithm (3DES)](#convert-a-private-key-to-pkcs8-using-a-pkcs12-compatible-algorithm-3des)
      - [Read a DER unencrypted PKCS#8 format private key](#read-a-der-unencrypted-pkcs8-format-private-key)
      - [Convert private key from any PKCS#8 format to traditional format:](#convert-private-key-from-any-pkcs8-format-to-traditional-format)
      - [Obtain certificate from a domain and create a `.pem`](#obtain-certificate-from-a-domain-and-create-a-pem)
      - [Add a set of certificates to a linux OS Key store](#add-a-set-of-certificates-to-a-linux-os-key-store)
    - [TLS validations with `openssl`](#tls-validations-with-openssl)
      - [Test SSL certificate of particular URL](#test-ssl-certificate-of-particular-url)
    - [Check SSL and TLS acceptance on target URL](#check-ssl-and-tls-acceptance-on-target-url)
      - [Check connectivity with SSL V2](#check-connectivity-with-ssl-v2)
      - [Check connectivity with SSL V3](#check-connectivity-with-ssl-v3)
      - [Check connectivity with TLS 1.0](#check-connectivity-with-tls-10)
      - [Check connectivity with TLS 1.1](#check-connectivity-with-tls-11)
      - [Check connectivity with TLS 1.2](#check-connectivity-with-tls-12)
      - [Verify if the particular cipher is accepted on a target URL](#verify-if-the-particular-cipher-is-accepted-on-a-target-url)
      - [Convert from Private Key `.pk8 ` to `.PEM`](#convert-from-private-key-pk8--to-pem)
    - [Java Key Store](#java-key-store)
      - [Generate JKS](#generate-jks)
      - [Import JKS](#import-jks)
      - [convert JKS to .PEM](#convert-jks-to-pem)
      - [Command to generate a `.keystore ` or ` .jks`](#command-to-generate-a-keystore--or--jks)
      - [Add a website certificate in `.pem` to the JKS](#add-a-website-certificate-in-pem-to-the-jks)
      - [Default JKS locations in different OS](#default-jks-locations-in-different-os)
      - [Delete elements imported in the JKS](#delete-elements-imported-in-the-jks)
      - [List contents of a JKS](#list-contents-of-a-jks)
    - [JKS conversions to OpenSSL](#jks-conversions-to-openssl)
      - [From `JKS` --\> `.p12` --\> `.PEM`](#from-jks----p12----pem)
    - [OpenSSH to OpenSSL](#openssh-to-openssl)
      - [Convert OpenSSH to PEM format ( format for SSH private keys and PEM is very close )](#convert-openssh-to-pem-format--format-for-ssh-private-keys-and-pem-is-very-close-)
    - [OpenSSL to OpenSSH](#openssl-to-openssh)
    - [GnuPG to OpenSSH](#gnupg-to-openssh)
    - [GPG GnuPG to OpenSSL](#gpg-gnupg-to-openssl)
    - [GnuPG S/MIME to OpenSSL](#gnupg-smime-to-openssl)
    - [OpenSSL to GnuPG S/MIME](#openssl-to-gnupg-smime)
    - [OpenSSH to GnuPG S/MIME](#openssh-to-gnupg-smime)
      - [Format `.P12` compatible with java JKS](#format-p12-compatible-with-java-jks)
      - [Import created key (`ssh-key.p12`)](#import-created-key-ssh-keyp12)
  - [**Notice you cannot import/export DSA ssh keys to/from GnuPG**](#notice-you-cannot-importexport-dsa-ssh-keys-tofrom-gnupg)
    - [Certificate filename extensions](#certificate-filename-extensions-1)
  - [Open SSH](#open-ssh)
    - [SSH Key Management](#ssh-key-management)
      - [Key generation - Generate SSH Key pair](#key-generation---generate-ssh-key-pair)
      - [Add a SSH key to ssh-agent](#add-a-ssh-key-to-ssh-agent)
      - [Get content of default name of Public Key](#get-content-of-default-name-of-public-key)
      - [Add SSH key to a remote Server](#add-ssh-key-to-a-remote-server)
    - [References](#references)

[Kiwiki Home](/../../)

## Security and Chryptography

Very broad topic. Tooling used for encryption, authorization and authentication are described here

#### Generate security encryption keys to sign packages
2020-09-25 Security Task for Android package

Here is some info i have found on my quest after using some `openssl` commands from this guide [Android release keys](https://wladimir-tm4pda.github.io/porting/release_keys.html)

```bash
#!/bin/bash

AUTH='/C=NZ/ST=Auckland/L=Locality 2/O=Android/OU=Android/CN=Android/emailAddress=user@email.com'
if [ "$1" == "" ]; then
        echo "Create a test certificate key."
        echo "Usage: $0 NAME"
        echo "Will generate NAME.pk8 and NAME.x509.pem"
        echo "  $AUTH"
        exit
fi
```
#### 2048 bits initial encryption. Upgraded to 4096 bits
```bash
openssl genrsa -3 -out $1.pem 2048
openssl req -new -x509 -key $1.pem -out $1.x509.pem -days 10000 -subj "$AUTH"
echo "Please enter the password for this key:"
openssl pkcs8 -in $1.pem -topk8 -outform DER -out $1.pk8 -passout stdin
```

# Encryption Concepts

## Certificate filename extensions

There are several commonly used filename extensions for X.509 certificates. Some of these extensions are also used for other data such as private keys.

- `.pem` – (Privacy-enhanced Electronic Mail) Base64 encoded DER certificate, enclosed between `"-----BEGIN CERTIFICATE-----"` and `"-----END CERTIFICATE-----"`
- `.cer`, `.crt`, `.der` – usually in binary DER form, but Base64-encoded certificates are common too (see .pem above)
- `.p7b`, `.p7c` – `PKCS#7` SignedData structure without data, just certificate(s) or CRL(s)
- `.p12` – `PKCS#12`, may contain certificate(s) (public) and private keys (password protected)
- `.pfx` – `PFX`, predecessor of `PKCS#12` (usually contains data in PKCS#12 format, e.g., with PFX files generated in IIS)
  PKCS#7 is a standard for signing or encrypting (officially called "enveloping") data. Since the certificate is needed to verify signed data, it is possible to include them in the SignedData structure. A .P7C file is a degenerated SignedData structure, without any data to sign.
- `PKCS#12` evolved from the personal information exchange `(PFX)` standard and is used to exchange public and private objects in a single file.

### X.509 Certificate
In cryptography, X.509 is a standard defining the format of public key certificates.
---

### Analyze and Check artifacts generated by `OpenSSL`

#### Check RSA Key
```bash
openssl rsa -in My_KEY.pem -check
```

#### Check X509 certificate
```bash
openssl x509 -in certificate.x509.pem -text -noout
```

#### read metadata of certificate and key
```bash
openssl x509 -text -in CERTIFICATE.pem
```

#### Convert private key to PKCS#5 v2.0 format using triple DES
```bash
openssl pkcs8 -in key.pem -topk8 -v2 des3 -out enckey.pem
```

#### Convert a private key to PKCS#8 using a PKCS#5 1.5 compatible algorithm (DES)
```bash
openssl pkcs8 -in key.pem -topk8 -out enckey.pem
```

#### Convert a private key to PKCS#8 using a PKCS#12 compatible algorithm (3DES)
```bash
openssl pkcs8 -in key.pem -topk8 -out enckey.pem -v1 PBE-SHA1-3DES
```

#### Read a DER unencrypted PKCS#8 format private key
```bash
openssl pkcs8 -inform DER -nocrypt -in key.der -out key.pem
```

#### Convert private key from any PKCS#8 format to traditional format:
```bash
openssl pkcs8 -in pk8.pem -out key.pem
```

#### Obtain certificate from a domain and create a `.pem`
```bash
DOMAIN="example.com"
NEW_CERT="certificate_TLS"

openssl s_client -showcerts -connect $DOMAIN:443 </dev/null 2>/dev/null|openssl x509 -outform PEM > NEW_CERT.pem
```

#### Add a set of certificates to a linux OS Key store

```bash
DOMAIN="example.com"
cp certificateDomain.pem /usr/local/share/ca-certificates/cloudbuilder.crt && update-ca-certificates
```
Output will look something like

```bash
Updating certificates in /etc/ssl/certs...
1 added, 0 removed; done.
Running hooks in /etc/ca-certificates/update.d...

Adding debian:certificate.pem
done.
Updating Mono key store
Linux Cert Store Sync - version 4.6.2.0
Synchronize local certs with certs from local Linux trust store.
Copyright 2002, 2003 Motus Technologies. Copyright 2004-2008 Novell. BSD licensed.

I already trust 149, your new list has 139
Certificate added: CN=*.marine.com.int
1 new root certificates were added to your trust store.
Import process completed.
Done
```

### TLS validations with `openssl`
SSL has now been deprecated in favor of Transport Layer Security

#### Test SSL certificate of particular URL

```bash
openssl s_client –showcerts -connect yoururl.com:443
```

### Check SSL and TLS acceptance on target URL

#### Check connectivity with SSL V2

```bash
openssl s_client -ssl2 -connect secureurl.com:443
```

#### Check connectivity with SSL V3

```bash
openssl s_client –ssl3 -connect secureurl.com:443
```

#### Check connectivity with TLS 1.0

```bash
openssl s_client -connect secureurl.com:443 –tls1
```

#### Check connectivity with TLS 1.1

```bash
openssl s_client -connect secureurl.com:443 –tls1_1
```

#### Check connectivity with TLS 1.2

```bash
openssl s_client –tls1_2 -connect secureurl.com:443
```

#### Verify if the particular cipher is accepted on a target URL

```bash
openssl s_client -cipher 'ECDHE-ECDSA-AES256-SHA' -connect secureURL:443
```

#### Convert from Private Key `.pk8 ` to `.PEM`
```bash
openssl pkcs8 -in $PRIV_KEY_NAME.pk8 -inform DER -nocrypt -out $NEW_PRIV_KEY_UNENCRYPTED.pem
```

### Java Key Store
GUI tool to explore the [JKS store](http://keystore-explorer.org/downloads.html)

#### Generate JKS

```bash
keytool -genkey -alias gdalias \
  -keystore www_gnudeveloper_com.jks \
  -keyalg RSA   -keysize 512 \
  -storepass gnudevpwd
```
#### Import JKS
```bash
keytool -importkeystore \
  -srcstoretype JKS \
  -deststoretype PKCS12 \
  -srckeystore www_gnudeveloper_com.jks \
  -destkeystore www_gnudeveloper_com.p12 \
  -storepass gnudevpwd
```
#### convert JKS to .PEM
```bash
openssl pkcs12 -in www_gnudeveloper_com.p12  -out www_gnudeveloper_com.pem
```

#### Command to generate a `.keystore ` or ` .jks`

```bash
echo y | keytool -genkeypair -dname "cn=Mark Jones, ou=JavaSoft, o=Sun, c=US" -alias business -keypass kpi135 -keystore /working/android.keystore -storepass ab987c -validity 20000
```

##### Flags explanation for command to generate KeyStores

- `dname=`is a unique identifier for the application in the .keystore. 
  - `cn=`the full name of the person or organization that generates the .keystore
  - `ou=`Organizational Unit that creates the project, its a subdivision of the Organization that creates it. Ex. android.google.com
  - `o=`Organization owner of the whole project. Its a higher scope than ou. Ex.: google.com
  - `c=`The country short code. Ex: For United States is "US"

- `alias=`Identifier of the app as an single entity inside the .keystore (it can have many) keypass=Password for protecting that specific alias.
- `keystore=`Path where the .keystore file shall be created (the standard extension is actually .ks)
- `storepass=`Password for protecting the whole .keystore content.
- `validity=`Amount of days the app will be valid with this `.keystore`

#### Add a website certificate in `.pem` to the JKS
```bash
keytool -import -alias mydomain.org.int -keystore ${JAVA_CERTS} -file PEM_FILE_Name.pem -storepass $ADD_PASS -noprompt
```

#### Default JKS locations in different OS

```bash
ORACLE_JDK_LINUX="/usr/lib/jvm/java-1.8.0-openjdk-amd64/jre/lib/security/cacerts"
OPEN_JDK_LINUX="/usr/lib/jvm/java-11-openjdk-amd64/lib/security/cacerts"
ORACLE_JDK_WIN="C:\Program Files\Java\jdk1.8.0_152\jre\lib\security\cacerts"
RED_HAT_JDK_WIN="C:\Program Files\RedHat\java-11-openjdk-11.0.9-3\lib\security\cacerts"
```

#### Delete elements imported in the JKS

```bash
keytool -delete -noprompt -trustcacerts -alias "initcert" -keystore "$OPEN_JDK_LINUX"
```

#### List contents of a JKS

```bash
keytool -list -keystore $ORACLE_JDK_LINUX
```

### JKS conversions to OpenSSL

#### From `JKS` --> `.p12` --> `.PEM`

### OpenSSH to OpenSSL
OpenSSH private keys are directly understable by OpenSSL

```bash
openssl rsa -in ~/.ssh/id_rsa -text
openssl dsa -in ~/.ssh/id_dsa -text
```

#### Convert OpenSSH to PEM format ( format for SSH private keys and PEM is very close )

```bash
openssl rsa -in ~/.ssh/id_rsa -out key_rsa.pem
openssl dsa -in ~/.ssh/id_dsa -out key_dsa.pem
```

So, you can directly use it to create a certification request:

```bash
openssl req -new -key ~/.ssh/id_dsa -out myid.csr
```

You can also use your ssh key to create a sef-signed certificate:

```bash
openssl x509 -req -days 3650 -in myid.csr -signkey ~/.ssh/id_rsa -out myid.crt
```

> **Notice:** I have not found how to manipulate Open SSH public keys with OpenSSL

### OpenSSL to OpenSSH

Private keys format is same between OpenSSL and OpenSSH. So you just a have to rename your OpenSSL key:
`cp myid.key id_rsa`

In OpenSSL, there is no specific file for public key
(public keys are generally embeded in certificates). Extract public key from private key file:
`ssh-keygen -y -f  myid.key > id_rsa.pub`

### GnuPG to OpenSSH

You need to know fingerprint of your RSA key. You can use:
`gpg --list-secret-keys --keyid-format short`

use `openpgp2ssh` tool distributed in with monkeyshpere project:

```bash
bash gpg --export-secret-keys 01234567 | openpgp2ssh 01234567 > id_rsa 
```

- A few notes are necessary:
  01234567 must be fingerprint of a RSA key (or subkey)
  `gpg --export-secret-keys` also accept finger print of global key (in this case, it exports all sub-keys). However, `openpgp2ssh` only accept finger print of an RSA key

If no arguments are provided, `openpgp2ssh` export RSA keys it find
You can now extract ssh public key using:
`ssh-keygen -y -f id_rsa > id_rsa.pub`

### GPG GnuPG to OpenSSL
Extract key as for ssh
- list GPG keys
```bash
gpg --list-secret-keys --keyid-format short
```
- convert to SSH format
```bash
GPG_KEY_ID="01234567"
gpg --export-secret-keys $GPG_KEY_ID | openpgp2ssh $GPG_KEY_ID > myid.key
```
- Convert key `myid.key` to PEM format
```bash
openssl rsa -in myid.key -out myid.pem
```
- create a certification request
```bash
openssl req -new -key myid.key -out myid.csr
```
- Create a sef-signed certificate
```bash
openssl x509 -req -days 3650 -in myid.csr -signkey myid.key -out myid.crt
```

### GnuPG S/MIME to OpenSSL

##### Gpgsm utility can exports keys and certificate in PCSC12
```bash
gpgsm -o secret-gpg-key.p12 --export-secret-key-p12 0xXXXXXXXX
```
You have to extract Key and Certificates separatly:

```bash
openssl pkcs12 -in secret-gpg-key.p12 -nocerts -out gpg-key.pem
openssl pkcs12 -in secret-gpg-key.p12 -nokeys -out gpg-certs.pem
```
You can now use it in OpenSSL. You can also do similar thing with GnuPG public keys. There will be only certificates output.

### OpenSSL to GnuPG S/MIME

- Invert process:

```bash
openssl pkcs12 -export -in gpg-certs.pem -inkey gpg-key.pem -out gpg-key.p12
gpgsm --import gpg-key.p12
GnuPG S/MIME to OpenSSH
```
- chain processes

```bash
gpgsm -o secret-gpg-key.p12 --export-secret-key-p12 0xXXXXXXXX

openssl pkcs12 -in secret-gpg-key.p12 -nocerts -out gpg-key.pem
```

- Protect key with the right permissions, else SSH will refuse it.

```bash
chmod 600 gpg-key.pem
cp gpg-key.pem ~/.ssh/id_rsa
ssh-keygen -y -f gpg-key.pem > ~/.ssh/id_rsa.pub
```

### OpenSSH to GnuPG S/MIME

- create a certificate (self-signed) for our ssh key

```bash
openssl req -new -x509 -key ~/.ssh/id_rsa -out ssh-cert.pem
```

- Import it in GnuPG

#### Format `.P12` compatible with java JKS

```bash
openssl pkcs12 -export -in ssh-certs.pem -inkey ~/.ssh/id_rsa -out ssh-key.p12
```

#### Import created key (`ssh-key.p12`)

```bash
gpgsm --import ssh-key.p12
```

**Notice you cannot import/export DSA ssh keys to/from GnuPG**
---

### Certificate filename extensions
There are several commonly used filename extensions for X.509 certificates. Some of these extensions are also used for other data such as private keys

- `.pem` – (Privacy-enhanced Electronic Mail) Base64 encoded DER certificate, enclosed between 
```bash
-----BEGIN CERTIFICATE-----
CERTIFICATE_CONTENT
-----END CERTIFICATE-----
```
- `.cer`, `.crt`, `.der` – usually in binary DER form, but Base64-encoded certificates are common too (see .pem above)

- `.p7b`, `.p7c` – PKCS#7 SignedData structure without data, just certificate(s) or CRL(s)

- `.p12` – `PKCS#12`, may contain certificate(s) (public) and private keys (password protected)

- `.pfx` – PFX, predecessor of PKCS#12 (usually contains data in PKCS#12 format, e.g., with PFX files generated in IIS)

- `PKCS#7` is a standard for signing or encrypting (officially called "enveloping") data. Since the certificate is needed to verify signed data, it is possible to include them in the SignedData structure.

- `.P7C` file is a degenerated SignedData structure, without any data to sign. PKCS#12 evolved from the personal information exchange (PFX) standard and is used to exchange public and private objects in a single file.

## Open SSH
Use a config `SSH` custom file to ease connectivity. 

> PuTTY in Windows will create keys with a `priv.ppk` format in windows vs Linux Open SSH key `id_rsa`
  
- [Official OpenSSH](https://www.openssh.com/)
- [SSH Academy](https://www.ssh.com/ssh/ssh-academy)
- [Digital Ocean custom SSH client](https://www.digitalocean.com/community/tutorials/how-to-configure-custom-connection-options-for-your-ssh-client#general-tweaks-and-connection-items)

### SSH Key Management

#### Key generation - Generate SSH Key pair
The key below will use 4096 encryption

```bash
SSH_KEY_EMAIL="person@example.com"
ssh-keygen -t rsa -b 4096 -C "$SSH_KEY_EMAIL"
```

#### Add a SSH key to ssh-agent

```bash
ssh-add -k ~/.ssh/id_rsa
ssh-keygen -t rsa
```

#### Get content of default name of Public Key

```bash
cat ~/.ssh/id_rsa.pub
```

#### Add SSH key to a remote Server

Read Public SSH key, ssh to \$REMOTE_HOST with root user. Create a hidden directory `.ssh` and add the public key to the `authorized_keys` file

```bash
COMMAND="mkdir -p ~/.ssh && cat >> ~/.ssh/authorized_keys"
cat ~/.ssh/id_rsa.pub | ssh root@$REMOTE_HOST $COMMAND
```

### References

- Taken from [mkssoftware](https://www.mkssoftware.com/docs/man1/openssl_pkcs8.1.asp)
- Digicert post on [Certificate and CA management](https://www.digicert.com/kb/ssl-support/openssl-quick-reference-guide.htm)
- OpenSSL [FreecodeCamp CheatSheet](https://www.freecodecamp.org/news/openssl-command-cheatsheet-b441be1e8c4a/)
- Great ssl.com [Post on conversions](https://www.ssl.com/guide/pem-der-crt-and-cer-x-509-encodings-and-conversions/)
- Simple explanation about formats GPG, OpenSSL and OpenSSH [at](https://blog.programster.org/key-file-formats)
- Old 2009 tool java based UI keytool-iui but still relevant. Link to [old google code](https://code.google.com/archive/p/keytool-iui/)
- [Release Keys](https://wladimir-tm4pda.github.io/porting/release_keys.html)
- [Oracle Docs for JKS: PEM to JKS conversion](https://docs.oracle.com/cd/E35976_01/server.740/es_admin/src/tadm_ssl_convert_pem_to_jks.html)
- Convert [keys between GnuPG, OpenSsh and OpenSSL](http://sysmic.org/dotclear/index.php?post/2010/03/24/Convert-keys-betweens-GnuPG%2C-OpenSsh-and-OpenSSL)
- [blog Cryptography RSA Open SSL](http://www.gnudeveloper.com/groups/cyber_security/Cryptography_RSA_Key_Exchange_works_in_realtime_using_Keytool_openSSL%20.html)
- Using GPG in Windows Subsystem Linux WSL GPG guide in Windows Subsystem for Linux [GPG in WSL by Jess Esquire](https://www.jessesquire.com/articles/2019/03/31/configure-github-activity-signing-with-wsl/)
[Back to top](#)

[Kiwiki Home](/../../)